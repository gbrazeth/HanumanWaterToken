#!/bin/bash

# HWT Vulnerability Monitor
# Monitora vulnerabilidades especÃ­ficas e sugere aÃ§Ãµes

echo "ğŸ” HWT Vulnerability Monitor - $(date)"
echo "========================================="

# FunÃ§Ã£o para contar vulnerabilidades por severidade
count_vulnerabilities() {
    local audit_output=$(npm audit --json 2>/dev/null)
    local high=$(echo "$audit_output" | jq -r '.metadata.vulnerabilities.high // 0')
    local moderate=$(echo "$audit_output" | jq -r '.metadata.vulnerabilities.moderate // 0')
    local low=$(echo "$audit_output" | jq -r '.metadata.vulnerabilities.low // 0')
    local total=$(echo "$audit_output" | jq -r '.metadata.vulnerabilities.total // 0')
    
    echo "ğŸ“Š Vulnerabilidades atuais:"
    echo "   ğŸ”´ High: $high"
    echo "   ğŸŸ¡ Moderate: $moderate" 
    echo "   ğŸŸ¢ Low: $low"
    echo "   ğŸ“ˆ Total: $total"
}

# FunÃ§Ã£o para verificar pacotes especÃ­ficos
check_specific_packages() {
    echo ""
    echo "ğŸ¯ Verificando pacotes crÃ­ticos:"
    
    # WalletConnect packages
    local wc_logger=$(npm list @walletconnect/logger --depth=0 2>/dev/null | grep -o "@walletconnect/logger@[0-9.]*" | head -1)
    local wc_core=$(npm list @walletconnect/core --depth=0 2>/dev/null | grep -o "@walletconnect/core@[0-9.]*" | head -1)
    
    echo "   ğŸ”— WalletConnect Logger: ${wc_logger:-"nÃ£o encontrado diretamente"}"
    echo "   ğŸ”— WalletConnect Core: ${wc_core:-"nÃ£o encontrado diretamente"}"
    
    # Web3Modal
    local web3modal=$(npm list @web3modal/wagmi --depth=0 2>/dev/null | grep -o "@web3modal/wagmi@[0-9.]*")
    echo "   ğŸŒ Web3Modal: ${web3modal:-"nÃ£o encontrado"}"
    
    # Ethers
    local ethers=$(npm list ethers --depth=0 2>/dev/null | grep -o "ethers@[0-9.]*")
    echo "   âš¡ Ethers: ${ethers:-"nÃ£o encontrado"}"
}

# FunÃ§Ã£o para sugerir aÃ§Ãµes
suggest_actions() {
    echo ""
    echo "ğŸ’¡ AÃ§Ãµes recomendadas:"
    echo "   1. ğŸ¤– Aguardar PRs do Dependabot (updates automÃ¡ticos)"
    echo "   2. ğŸ”„ Executar 'npm run deps:update' semanalmente"
    echo "   3. ğŸ“Š Monitorar https://github.com/gbrazeth/HanumanWaterToken/security"
    echo "   4. ğŸ›¡ï¸ Considerar migraÃ§Ã£o ethers v5â†’v6 quando estÃ¡vel"
    echo ""
    echo "ğŸš¨ Vulnerabilidades HIGH sÃ£o principalmente do ecosystem Web3"
    echo "   - @walletconnect/* packages (aguardando updates upstream)"
    echo "   - @web3modal/* packages (dependem do WalletConnect)"
    echo ""
    echo "âœ… Medidas de mitigaÃ§Ã£o ativas:"
    echo "   - Overrides forÃ§ados para versÃµes mais seguras"
    echo "   - Dependabot configurado para updates automÃ¡ticos"
    echo "   - Monitoramento contÃ­nuo implementado"
}

# Executar verificaÃ§Ãµes
count_vulnerabilities
check_specific_packages
suggest_actions

echo ""
echo "ğŸ”— Links Ãºteis:"
echo "   - GitHub Security: https://github.com/gbrazeth/HanumanWaterToken/security"
echo "   - WalletConnect Status: https://github.com/WalletConnect/walletconnect-monorepo"
echo "   - Web3Modal Status: https://github.com/WalletConnect/web3modal"
echo ""
echo "âœ… Monitor completo!"
echo "========================================="
